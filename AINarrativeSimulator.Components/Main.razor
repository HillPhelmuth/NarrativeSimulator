<div class="app-shell">
    <!-- Header -->
    <header class="site-header">
        <div class="container">
            <div class="header-row">
                <div class="brand">
                    <div class="brand-icon" title="home" @onclick="@(() => Navigation.NavigateTo("/"))"><img src="NarrativeZooAppIcon.jpeg" height="32" width="32" /></div>
                    <div>
                        <h1 class="brand-title">The Emergent Narrative Simulator</h1>
                        <p class="brand-subtitle">@WorldState.Name - @WorldState.Description</p>
                    </div>
                </div>
                <div class="header-right">
                    <div class="header-actions">
                        <div class="snapshot-group">
                            <button class="btn btn-secondary" @onclick="SaveSnapshot" title="Save current world state to browser storage">Save</button>
                            <div class="snapshot-dropdown" @onclick:stopPropagation>
                                <button class="btn btn-secondary" @onclick="ToggleSnapshots" title="View saved snapshots">Load (@_snapshots.Count)</button>
                                @if(_showSnapshots)
                                {
                                    <div class="snapshot-menu">
                                        @if(_snapshots.Count == 0)
                                        {
                                            <div class="snapshot-empty">No snapshots saved</div>
                                        }
                                        else
                                        {
                                            @foreach(var s in _snapshots.OrderByDescending(s=>s.CreatedUtc))
                                            {
                                                <div class="snapshot-item">
                                                    <div class="snap-meta" @onclick="(() => LoadSnapshot(s.Id))">
                                                        <div class="snap-name">@s.Name</div>
                                                        <div class="snap-time">@s.CreatedUtc.ToLocalTime().ToString("HH:mm:ss")</div>
                                                    </div>
                                                    <button class="snap-delete" title="Delete snapshot" @onclick="(() => DeleteSnapshot(s.Id))">×</button>
                                                </div>
                                            }
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                        <button class="btn btn-primary" @onclick="OpenSummaryModal">Generate World Summary</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container main-content">
        <div class="main-grid" style="--col1:@Col1Size; --col2:@Col2Size; --col3:@Col3Size;" @ref="_grid">
            <!-- Left Column - Event Feed / Beats -->
            <div class="col @( _minCol1 ? "minimized" : string.Empty)">
                @if (!_minCol1)
                {
                    <button class="mini-toggle" title="Minimize" @onclick="() => ToggleCol(1)">–</button>
                    <div class="view-toggle" title="Toggle between Beats and Events">
                        <label class="switch">
                            <input type="checkbox" aria-label="Toggle view" @bind="_showComics" />
                            <span class="slider"></span>
                        </label>
                        <span class="toggle-text">@(_showComics ? "Beats" : "Events")</span>
                    </div>
                    @if (_showComics)
                    {
                        <BeatTicker Beats="WorldState.Beats"></BeatTicker>
                    }
                    else
                    {
                        <EventFeed Actions="@_actions" />
                    }
                }
                else
                {
                    <div class="minimized-indicator" title="Restore Events/Beats" @onclick="() => ToggleCol(1)">Events ▸</div>
                }
            </div>
            <!-- Gutter between col 1 and 2 -->
            <div class="gutter" data-gutter="1" aria-hidden="true"></div>

            <!-- Middle Column - Agent Inspector -->
            <div class="col @( _minCol2 ? "minimized" : string.Empty)">
                @if (!_minCol2)
                {
                    <button class="mini-toggle" title="Minimize" @onclick="() => ToggleCol(2)">–</button>
                    <div class="view-toggle" style="z-index:100" title="Toggle between Details and Personality Dashboard">
                        <label class="switch">
                            <input type="checkbox" aria-label="Toggle view" @bind="_showPersonalityDash" />
                            <span class="slider"></span>
                        </label>
                        <span class="toggle-text">@(_showPersonalityDash ? "Big-5" : "Details")</span>
                    </div>
                    @if (_showPersonalityDash)
                    {
                        <PersonalityDashboard />
                    }
                    else
                    {
                        <AgentInspector Agents="@WorldState.WorldAgents?.Agents" SelectedAgentId="@selectedAgentId" SelectedAgentIdChanged="@OnSelectedAgentChanged"/>
                    }
                }
                else
                {
                    <div class="minimized-indicator" title="Restore Agent Inspector" @onclick="() => ToggleCol(2)">Agents ▸</div>
                }
            </div>

            <!-- Gutter between col 2 and 3 -->
            <div class="gutter" data-gutter="2" aria-hidden="true"></div>
            <!-- Right Column - World Controller -->
            <div class="col @( _minCol3 ? "minimized" : string.Empty)">
                @if (!_minCol3)
                {
                    <button class="mini-toggle" title="Minimize" @onclick="() => ToggleCol(3)">–</button>
                    <WorldController IsRunning="@isRunning"
                                     OnStart="@HandleStart"
                                     OnStop="@HandleStop"
                                     OnReset="@HandleReset"
                                     InjectRumor="@HandleInjectRumor"
                                     InjectEvent="@HandleInjectEvent"
                                     WorldState="@WorldState" />
                }
                else
                {
                    <div class="minimized-indicator" title="Restore World Controller" @onclick="() => ToggleCol(3)">World ▸</div>
                }
            </div>
        </div>

        <!-- Description Panel -->
       
    </main>

    <!-- Subtle background effect -->
    <div class="bg-stripe" aria-hidden="true"></div>
</div>

@if (_showSummaryModal)
{
    <div class="modal-backdrop" @onclick="CloseSummaryModal">
        <div class="modal-card" @onclick:stopPropagation>
            <div class="modal-header">
                <div class="modal-title">World Summary</div>
                <button class="btn-close" @onclick="CloseSummaryModal">×</button>
            </div>
            <div class="modal-body">
                @if (_isSummarizing)
                {
                    <div class="loading">
                        <div class="spinner-border text-info" role="status">
                            <span class="visually-hidden">Generating...</span>
                        </div>
                        <span>Generating summary...</span>
                    </div>
                }
                else
                {
                    <div class="markdown" style="max-height:50vh; overflow:auto;">
                        @((MarkupString)MarkdownAsHtml(_summary ?? string.Empty))
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseSummaryModal">Close</button>
                <button class="btn btn-primary" @onclick="GenerateSummary">Regenerate</button>
            </div>
        </div>
    </div>
}
